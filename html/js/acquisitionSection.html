<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Acquisition Section</title>
</head>
<body>
    <div class="row">
        <p>ADC control</p>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <p id="ADC_state">No connection</p>
            <button class="btn btn-info" id="ADC_reboot_button">Reboot</button>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <label for="next_shot_number">Next shot №:</label><output id="next_shot_number"></output>

            <label for="is_plasma">Is plasma?</label><input type="checkbox" id="is_plasma" checked>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <button class="btn btn-success" id="ADC_arm_button">Arm</button>
            <button class="btn btn-danger" id="ADC_disarm_button">Disarm</button>
        </div>
    </div>
    <hr>
    <div id="diag_row">
        <p>Diagnostics control</p>
        <label for="config_select">Configuration:</label><select id="config_select" class="configs"></select>
        <label for="spectral_select">Spectral calibr.:</label><select id="spectral_select" class="sp_calibrations"></select>
        <label for="abs_select">Abs. calibr.:</label><select id="abs_select" class="abs_calibrations"></select>
    </div>
    <hr>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                <div id="acq_gas_evo_chart" style="width:100%; height:400px;" gas evo></div>
            </div>
        </div>
        <label for="gas_mult">Gas Valve coefficient [10^19 V/m^-3]</label>
        <input id="gas_mult" type="number" value="0.01" min="0.0" step="0.01">
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-success glyphicon glyphicon glyphicon-arrow-up" id="ne_up" style="width:60px; height:60px; margin-bottom: 10px; margin-top: 10px;"></button>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
            </div>
        </div>
        <div class="row">
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-success glyphicon glyphicon glyphicon-arrow-left" id="ne_left" style="width:60px; height:60px; margin-bottom: 10px; margin-top: 10px;"></button>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">

            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-success glyphicon glyphicon glyphicon-arrow-right" id="ne_right" style="width:60px; height:60px; margin-bottom: 10px; margin-top: 10px;"></button>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-success glyphicon glyphicon glyphicon-arrow-down" id="ne_down" style="width:60px; height:60px; margin-bottom: 10px; margin-top: 10px;"></button>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
            </div>
        </div>
        <div class="row">
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-info" id="ne_prev" style="width:100%; height:40px; margin-bottom: 10px; margin-top: 10px;">prev</button>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-danger" id="ne_upload" style="width:100%; height:40px; margin-bottom: 10px; margin-top: 10px;">Upload</button>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button class="btn btn-info" id="ne_next" style="width:100%; height:40px; margin-bottom: 10px; margin-top: 10px;">next</button>
            </div>
        </div>
    </div>
    </div>
</body>

<script>
    function Main () {
        this.m_status_timer = null;
        this.last_update = 0;

        this.aqc_gas_evo_chart = new CanvasJS.Chart("acq_gas_evo_chart", {
            title: {
                text: 'Electron density program',
                fontSize: 14,
                fontFamily: 'arial'
            },
            axisY: {
                includeZero: true,
                title: 'Electron density, m⁻³',
                titleFontSize: 12,
                labelFormatter: function ( e ) {
                    return e.value.toExponential(1);
                },
                minimum: 0,
                fontFamily: 'arial'
            },
            axisX: {
                title: "Time, ms",
                titleFontSize: 12,
                minimum: 110,
                maximum: 260,
                crosshair: {
                    enabled: true,
                    snapToDataPoint: true,
                    labelFormatter: function(e) {
                        return e.value.toFixed(1);
                    }
                },
                fontFamily: 'arial'
            },
            toolTip: {
                //backgroundColor: "rgba(255,255,255,.2)",
                shared: true,
                contentFormatter: function(e){
                    let text = '<p>time = ' + e.entries[0].dataPoint.x.toFixed(1) + 'ms</p>';
                    for(let entry of e.entries){
                        if(typeof entry.dataPoint.y == 'number'){
                            text += '<p style="color:' + entry.dataSeries.color + ';">' + entry.dataSeries.options.name + ', T<sub>e</sub> = ' + entry.dataPoint.y.toFixed(1);
                        }
                    }
                    return text;
                }.bind(this),
            },
            legend: {
                cursor: "pointer",
                itemmouseover: function(e) {
                    if(e.dataSeries.visible) {
                        this.aqc_gas_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_defaults.line_thickness_high;
                        this.aqc_gas_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_defaults.line_thickness_high;
                        this.aqc_gas_evo_chart.render();
                    }
                }.bind(this),
                itemmouseout: function(e) {
                    if(e.dataSeries.visible) {
                        this.aqc_gas_evo_chart.options.data[e.dataSeriesIndex].lineThickness = this.m_defaults.line_thickness_base;
                        this.aqc_gas_evo_chart.options.data[e.dataSeriesIndex + 1].lineThickness = this.m_defaults.line_thickness_base;
                        this.aqc_gas_evo_chart.render();
                    }
                }.bind(this),
                itemclick: function (e) {
                    e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                    this.aqc_gas_evo_chart.render();
                }.bind(this)
            },
            data: []
        });
        this.aqc_gas_evo_chart.render();

        this.setTimer = function(){
            let delay = 1000;
            this.m_status_timer = setTimeout(function request() {
                this.ADCState();
                //if (ошибка запроса из-за перегрузки сервера) {
                // увеличить интервал для следующего запроса
                //  delay *= 2;
                //}
                this.m_status_timer = setTimeout(request.bind(this), delay);

            }.bind(this), delay);
        }

        this.Request = function (req, callback) {
            $.post('/api', JSON.stringify(req), callback, 'json');
        };

        //ADC
        this.ADCReboot = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'reboot'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCArm = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'arm',
                    is_plasma: $('#is_plasma')[0].checked
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCDisarm = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'disarm'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCState = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'state'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }else{
                        this.last_update = resp.unix;
                        if(resp.alive){
                            if(resp.armed){
                                $('#ADC_state').css('background-color','green');
                                $('#ADC_state').html('Armed ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');
                                $('#ADC_arm_button').prop("disabled", true);
                                $('#ADC_disarm_button').prop( "disabled", false);
                            }else {
                                $('#ADC_state').css('background-color', 'white');
                                $('#ADC_state').html('Ready ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');
                                $('#ADC_arm_button').prop("disabled", false);
                                $('#ADC_disarm_button').prop("disabled", true);
                            }
                        }else{
                            $('#ADC_state').css('background-color','red');
                            $('#ADC_state').html('Not connected ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');

                            //disable buttons!
                        }
                        if($('#is_plasma')[0].checked){
                            $('#next_shot_number').val(resp.plasma_shotn);
                        }else{
                            $('#next_shot_number').val(resp.debug_shotn);
                        }
                    }
                }
            );
        };

        this.ConnectControls = function () {
            $('#ADC_reboot_button').on('click', this, this.ADCReboot);
            $('#ADC_arm_button').on('click', this, this.ADCArm);
            $('#ADC_disarm_button').on('click', this, this.ADCDisarm);
        };

        this.ConnectControls();
        this.setTimer();
    }

    $(document).ready(function () {
            let viewer = new Main();
        })
</script>
</html>