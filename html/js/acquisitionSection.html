<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Acquisition Section</title>
</head>
<body>
    <div class="row">
        <p>ADC control</p>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <p id="ADC_state">No connection</p>
            <button class="btn btn-info" id="ADC_reboot_button">Reboot</button>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <label for="next_shot_number">Next shot №:</label><output id="next_shot_number"></output>

            <label for="is_plasma">Is plasma?</label><input type="checkbox" id="is_plasma" checked>
        </div>
        <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
            <button class="btn btn-success" id="ADC_arm_button">Arm</button>
            <button class="btn btn-danger" id="ADC_disarm_button">Disarm</button>
        </div>
    </div>
    <hr>
    <div id="diag_row">
        <p>Diagnostics control</p>
        <label for="config_select">Configuration:</label><select id="config_select" class="configs"></select>
        <label for="spectral_select">Spectral calibr.:</label><select id="spectral_select" class="sp_calibrations"></select>
        <label for="abs_select">Abs. calibr.:</label><select id="abs_select" class="abs_calibrations"></select>
    </div>
    </div>
</body>

<script>
    function Main () {
        this.m_status_timer = null;
        this.last_update = 0;
        this.setTimer = function(){
            let delay = 1000;
            this.m_status_timer = setTimeout(function request() {
                this.ADCState();
                //if (ошибка запроса из-за перегрузки сервера) {
                // увеличить интервал для следующего запроса
                //  delay *= 2;
                //}
                this.m_status_timer = setTimeout(request.bind(this), delay);

            }.bind(this), delay);
        }

        this.Request = function (req, callback) {
            $.post('/api', JSON.stringify(req), callback, 'json');
        };

        //ADC
        this.ADCReboot = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'reboot'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCArm = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'arm',
                    is_plasma: $('#is_plasma')[0].checked
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCDisarm = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'disarm'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }
                }
            );
        }.bind(this);

        this.ADCState = function(){
            this.Request(
                {
                    subsystem: 'ADC',
                    reqtype: 'state'
                }
                , function (resp) {
                    if(!resp.ok){
                        console.log(resp);
                        alert(resp.err);
                    }else{
                        this.last_update = resp.unix;
                        if(resp.alive){
                            if(resp.armed){
                                $('#ADC_state').css('background-color','green');
                                $('#ADC_state').html('Armed ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');
                                $('#ADC_arm_button').prop("disabled", true);
                                $('#ADC_disarm_button').prop( "disabled", false);
                            }else {
                                $('#ADC_state').css('background-color', 'white');
                                $('#ADC_state').html('Ready ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');
                                $('#ADC_arm_button').prop("disabled", false);
                                $('#ADC_disarm_button').prop("disabled", true);
                            }
                        }else{
                            $('#ADC_state').css('background-color','red');
                            $('#ADC_state').html('Not connected ' + ((this.last_update - 1e-3 * Date.now())).toFixed(0) + ' (s)');

                            //disable buttons!
                        }
                        if($('#is_plasma')[0].checked){
                            $('#next_shot_number').val(resp.plasma_shotn);
                        }else{
                            $('#next_shot_number').val(resp.debug_shotn);
                        }
                    }
                }
            );
        };

        this.ConnectControls = function () {
            $('#ADC_reboot_button').on('click', this, this.ADCReboot);
            $('#ADC_arm_button').on('click', this, this.ADCArm);
            $('#ADC_disarm_button').on('click', this, this.ADCDisarm);
        };

        this.ConnectControls();
        this.setTimer();
    }

    $(document).ready(function () {
            let viewer = new Main();
        })
</script>
</html>